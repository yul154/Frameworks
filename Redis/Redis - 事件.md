# 事件机制
> Redis中的事件驱动库只关注网络IO,定时器。

Redis事件(`src/ae.c`)处理下面两类事件： 
* 文件事件(file event)：用于处理 Redis 服务器和客户端之间的网络IO
* 时间事件(time eveat)：Redis 服务器中的一些操作（比如serverCron函数）需要在给定的时间点执行，而时间事件就是处理这类定时操作的。

`aeEventLoop`是整个事件驱动的核心，它管理着文件事件表和时间事件列表，不断地循环处理着就绪的文件事件和到期的时间事件。

## 文件事件
> 基于Reactor模式开发了自己的网络事件处理器，也就是文件事件处理器

文件事件处理器使用IO多路复用技术,同时监听多个套接字，并为套接字关联不同的事件处理函数。当套接字的可读或者可写事件触发时，就会调用相应的事件处理函数。

### redis的IO多路复用
```
* Redis的瓶颈主要在IO而不是CPU
* Redis 是单线程主要是指Redis 的网络 IO 和键值对读写是由一个线程来完成的，这也是 Redis 对外提供键值存储服务的主要流程。
```

Redis事件响应框架`ae_event`及文件事件处理器

<img width="514" alt="Screen Shot 2021-12-08 at 10 52 39 AM" src="https://user-images.githubusercontent.com/27160394/145139985-a2f6f49c-7900-46e3-bc4f-0485e449e396.png">

* 文件事件是对套接字操作的抽象，每当一个套接字准备好执行 accept、read、write和 close 等操作时，就会产生一个文件事件。因为 Redis 通常会连接多个套接字，所以多个文件事件有可能并发的出现
* I/O多路复用程序负责监听多个套接字，并向文件事件派发器传递那些产生了事件的套接字
* I/O多路复用程序总是会将所有产生的套接字都放到同一个队列(eEventLoop的fired)里边，然后文件事件处理器会以有序,同步,单个套接字的方式处理该队列中的套接字，也就是处理就绪的文件事件


#### Redis客户端与服务器进行连接并且发送命令的过程
1. 客户端向服务端发起建立 socket 连接的请求，那么监听套接字将产生 AE_READABLE 事件，触发连接应答处理器执行
2. 处理器会对客户端的连接请求进行应答，然后创建客户端套接字，以及客户端状态，并将客户端套接字的 AE_READABLE 事件与命令请求处理器关联
3. 客户端建立连接后，向服务器发送命令，那么客户端套接字将产生` AE_READABLE`事件，触发命令请求处理器执行，处理器读取客户端命令，然后传递给相关程序去执行
4. 执行命令获得相应的命令回复，为了将命令回复传递给客户端，服务器将客户端套接字的`AE_WRITEABLE`事件与命令回复处理器关联。
5. 当客户端试图读取命令回复时，客户端套接字产生`AE_WRITEABLE`事件，触发命令回复处理器将命令回复全部写入到套接字中。


#### Redis IO多路复用模型
* Redis 使用的IO多路复用技术主要有：select、epoll、evport和kqueue等。每个IO多路复用函数库在 Redis 源码中都对应一个单独的文件，比如ae_select.c，ae_epoll.c， ae_kqueue.c
* 在 Redis 只运行单线程的情况下，该机制允许内核中，同时存在多个监听套接字和已连接套接字
* 内核会一直监听这些套接字上的连接请求或数据请求。一旦有请求到达，就会交给 Redis 线程处理，这就实现了一个 Redis 线程处理多个 IO 流的效果
* 基于多路复用的Redis高性能IO模型为了在请求到达时能通知到Redis线程，select/epoll 提供了基于事件的回调机制，即针对不同事件的发生，调用相应的处理函数
  * select/epoll 一旦监测到 FD 上有请求到达时，就会触发相应的事件。这些事件会被放进一个事件队列
  * Redis 单线程对该事件队列不断进行处理

----
## 时间事件

* 定时事件：让一段程序在指定的时间之后执行一次。
* 周期性事件：让一段程序每隔指定时间就执行一次。

一个时间事件是定时事件还是周期性事件取决于时间处理器的返回值：
*  如果返回值是`AE_NOMORE`，那么这个事件是一个定时事件，该事件在达到后删除，之后不会再重复。
*  如果返回值是非`AE_NOMORE`的值，那么这个事件为周期性事件，当一个时间事件到达后，服务器会根据时间处理器的返回值，对时间事件的 when 属性进行更新，让这个事件在一段时间后再次达到。

服务器所有的时间事件都放在一个无序链表中，每当时间事件执行器运行时，它就遍历整个链表，查找所有已到达的时间事件，并调用相应的事件处理器

## aeEventLoop的具体实现
